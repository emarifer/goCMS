version: '3.8'

services:
  golang_app:
    image: emarifer/gocms:0.1
    ports:
      - "8080:8080"
    volumes:
      - type: bind
        source: .
        target: /gocms
        volume:
          nocopy: true
    command: ./gocms/compose-run.sh
    depends_on:
      mariadb:
        condition: service_healthy
    restart: always
    networks:
      - common-net

  mariadb:
    image: mariadb:jammy
    container_name: mariadb
    volumes:
      # - ./_mariadb_app_data:/var/lib/mysql
      - ./mariadb_init:/docker-entrypoint-initdb.d
    ports:
      - 3306:3306
    environment:
      # MARIADB_PASSWORD: root
      # MARIADB_DATABASE: urchin
      MARIADB_ROOT_PASSWORD: my-secret-pw
    healthcheck:
      test: [ "CMD", "mariadb", "-u", "root", "-pmy-secret-pw", "-e", "USE cms_db" ]
      interval: 10s
      timeout: 10s
      retries: 10
    networks:
      - common-net

networks:
  common-net: {}

# docker exec -it mariadb mariadb -uroot -pmy-secret-pw [mariadb container]
# docker exec -it gocms-golang_app-1 sh [gocms-golang_app-1 container]
# command & regular expression to capture the volume id/name:
# docker container inspect mariadb | egrep '\"Name\": \"[0-9a-f]{64}\"'
# VIEWING CONTAINER SIZE:
# https://docs.docker.com/reference/cli/docker/inspect/
# https://refine.dev/blog/docker-list-containers/#viewing-container-size:
# docker ps --size (Only running containers)
# HOW TO GET THE CREATION DATE OF A DOCKER VOLUME:
# https://stackoverflow.com/questions/75150068/how-to-get-the-creation-date-of-a-docker-volume
# COMMAND:
# docker volume ls --quiet | xargs docker volume inspect --format '{{ .CreatedAt }} {{ .Name }}' | sort
# DETECT DUBIOUS OWNERSHIP IN REPOSITORY AT DOCKER CONTAINER:
# https://docs.docker.com/compose/compose-file/compose-file-v3/#volumes
# https://community.jenkins.io/t/detected-dubious-ownership-in-repository-with-jenkins-upgrade/6182

# =========== OTHER REFERENCES ===========
# docker compose up -d

# docker exec -it gocms-db mariadb --user root -p # or alternatively:
# docker exec -it gocms-db mariadb -uroot -pmy-secret-pw
# (Enter password:my-secret-pw)
# show databases;
# use cms_db;
# show tables;
# show columns from posts; // describe posts; (is the same)
# get the last 4 records from the "images" table:
# SELECT * FROM images ORDER BY created_at DESC LIMIT 4;

# Bootstrap with development data. SEE:
# https://www.beekeeperstudio.io/blog/how-to-use-mariadb-with-docker

# CURRENT TIMESTAMP IN MARIADB. SEE:
# https://mariadb.com/kb/en/timestamp/
# https://stackoverflow.com/questions/40864951/mariadb-current-timestamp-default

# USING GOOSE:
# export GOOSE_DRIVER=mysql
# export GOOSE_DBSTRING="root:my-secret-pw@tcp(localhost:3306)/cms_db"
# MAIN COMMANDS:
# goose create add_sample_post sql
# goose up / goose down
# REST OF COMMANDS:
# https://citizix.com/managing-database-migrations-with-golang-goose-using-incremental-sql-changes/
# https://github.com/pressly/goose